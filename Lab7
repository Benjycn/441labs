# 1, referencing from "web_gpio_post.py" ddevoe-umd git
import RPi.GPIO as GPIO
import threading, socket
from time import sleep

led_pins = [23, 24, 25]  
f = 1000           
brightness = [0, 0, 0]    
pwms = []

# referencing lab5
GPIO.setmode(GPIO.BCM)
for pin in led_pins:
    GPIO.setup(pin, GPIO.OUT)
    pwm = GPIO.PWM(pin, f)
    pwm.start(0)
    pwms.append(pwm)

def change_brightness(index, value): # min and max 0-100%
    value = int(value)
    if value < 0:
        value = 0
    if value > 100:
        value = 100
    brightness[index] = value
    pwms[index].ChangeDutyCycle(value)

# module 7, pg 20. helper function
def parsePOSTdata(data):
    # "Helper function to extract key,value pairs of POST data"
    data_dict = {}
    idx = data.find('\r\n\r\n') + 4
    data = data[idx:]
    data_pairs = data.split('&')
    for pair in data_pairs:
        key_val = pair.split('=')
        if len(key_val) == 2:
            data_dict[key_val[0]] = key_val[1]
    return data_dict

# leveraged chatgpt for general format and made adjustments by using w3schools to test and run
def web_page():
    """Return HTML page with form and current LED values"""
    html = """
    <html><head><title>LED Brightness Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    html{font-family: Helvetica; text-align:center;}
    .button{background:#0F3376; color:white; padding:10px 25px;
            border:none; border-radius:6px; cursor:pointer;}
    </style></head><body>
    <h1>Problem 1: LED Brightness Control</h1>
    <form action="/" method="POST">
      <p>Select LED:</p>
      <label><input type="radio" name="led" value="0" checked> LED1</label>
      <label><input type="radio" name="led" value="1"> LED2</label>
      <label><input type="radio" name="led" value="2"> LED3</label><br><br>
      <label>Brightness (0â€“100):</label>
      <input type="text" name="value" value="50"><br><br>
      <button class="button" type="submit">Set Brightness</button>
    </form>
    <h3>Current Brightness</h3>
    <ul>
      <li>LED1: """ + str(brightness[0]) + """%</li>
      <li>LED2: """ + str(brightness[1]) + """%</li>
      <li>LED3: """ + str(brightness[2]) + """%</li>
    </ul>
    </body></html>
    """
    return bytes(html, 'utf-8')

# reference ddevoe-umd git for post.py
def serve_web_page():
    while True:
        print("Waiting for connection...")
        conn, (client_ip, client_port) = s.accept()
        print(f"Connection from {client_ip}:{client_port}")
        client_message = conn.recv(2048).decode('utf-8')
        print(f"Message from client:\n{client_message}")

        #parse the request, extract, and convert to int values for brightness change
        data_dict = parsePOSTdata(client_message)
        if 'led' in data_dict and 'value' in data_dict:
            led = int(data_dict['led'])
            value = int(data_dict['value'])
            change_brightness(led, value)

        conn.send(b'HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n')
        conn.sendall(web_page())
        conn.close()

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(('', 80))
s.listen(3)

webpageThread = threading.Thread(target=serve_web_page, daemon=True)
webpageThread.start()

try:
    while True:
        sleep(1)
except KeyboardInterrupt:
    print('\nExiting')
    for pwm in pwms: 
        pwm.stop()
    GPIO.cleanup()
    s.close()
